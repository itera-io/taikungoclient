name: Generate Client

on:
  workflow_call:
    inputs:
      branch:
        required: true
        type: string
      force:
        required: false
        type: boolean
        description: 'Force client generation'
        default: false
    secrets:
      url:
        required: true
      showback_url:
        required: true

jobs:
  build:
    name: Generate
    runs-on: self-hosted
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ inputs.branch }}

      - name: Download swagger-web.json
#        run: wget -q "$SWAGGER_URL" -O swagger-web.json
        run: wget -q https://github.com/itera-io/taikungoclient/blob/12ef2364b7cffbfdb82602bae8141df257cdeac4/mock-api/swagger-web.json -O swagger-web.json
        shell: bash
        env:
          SWAGGER_URL: ${{ secrets.url }}

      - name: Download swagger-showback.json
#        run: wget -q "$SHOWBACK_SWAGGER_URL" -O swagger-showback.json
        run: wget -q https://github.com/itera-io/taikungoclient/blob/12ef2364b7cffbfdb82602bae8141df257cdeac4/mock-api/swagger-showback.json -O swagger-showback.json
        shell: bash
        env:
          SHOWBACK_SWAGGER_URL: ${{ secrets.showback_url }}

      - name: Should regenerate client
        id: check
        shell: bash
        run: |
          [[ ${{ inputs.force }} = true ]] || ./.github/should_regenerate_client.sh
        continue-on-error: true

      - name: Setup Git
        if: steps.check.outcome == 'success'
        shell: bash
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com

      - name: Set up Go
        if: steps.check.outcome == 'success'
        uses: actions/setup-go@v3
        with:
          go-version: '1.17'

#      - name: Install Go-Swagger
#        if: steps.check.outcome == 'success'
#        shell: bash
#        run: |
#          download_url=$(curl -s https://api.github.com/repos/go-swagger/go-swagger/releases/latest | jq -r '.assets[] | select(.name | contains("'"$(uname | tr '[:upper:]' '[:lower:]')"'_amd64")) | .browser_download_url')
#          curl -o swagger -L'#' "$download_url"
#          chmod +x swagger

      - name: Download OpenAPI generator
        run: | 
          wget -q https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/7.0.1/openapi-generator-cli-7.0.1.jar -O openapi-generator-cli.jar

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu' # See 'Supported distributions' for available options
          java-version: '17'

      - name: Generate Client
        if: steps.check.outcome == 'success'
        run: ./.github/generate_client.sh
        shell: bash

      - name: Delete swagger-web.json
        if: steps.check.outcome == 'success'
        run: rm swagger-web.json
        shell: bash

      - name: Delete swagger-showback.json
        if: steps.check.outcome == 'success'
        run: rm swagger-showback.json
        shell: bash

      - name: Delete go-swagger
        if: steps.check.outcome == 'success'
        run: rm swagger
        shell: bash

      - name: Commit
        if: steps.check.outcome == 'success'
        shell: bash
        run: |
          git add .
          git commit -m "feat: update generated client"

      - name: Push
        if: steps.check.outcome == 'success'
        shell: bash
        run: git push
